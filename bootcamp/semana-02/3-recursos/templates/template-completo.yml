# ============================================================================
# TEMPLATE COMPLETO - Stack de producci√≥n con m√∫ltiples servicios
# ============================================================================
#
# ¬øQU√â ES ESTO?
# - Plantilla robusta para proyectos finales de implantaci√≥n
# - Incluye Frontend, Backend API, Base de datos y Administrador
#
# ¬øPARA QU√â SIRVE?
# - Proyectos de mayor envergadura con separaci√≥n de capas
# - Simular arquitectura de aplicaciones reales
# - Preparaci√≥n para ambientes de producci√≥n
#
# ¬øC√ìMO USARLO?
# 1. Copiar y adaptar seg√∫n las necesidades del proyecto
# 2. Ajustar puertos, vol√∫menes y variables de entorno
# 3. Implementar el c√≥digo del backend en la carpeta correspondiente
# ============================================================================

services:
  # ---------------------------------------------------------------------------
  # SERVICIO: Frontend (Nginx + HTML/CSS/JS)
  # ---------------------------------------------------------------------------
  # ¬øQu√©? - Servidor web para la interfaz de usuario
  # ¬øPara qu√©? - Presentar la aplicaci√≥n al usuario final
  # ¬øC√≥mo? - Sirve archivos est√°ticos y puede hacer proxy al backend
  frontend:
    image: nginx:alpine
    container_name: proyecto_frontend
    restart: unless-stopped

    volumes:
      - ./frontend:/usr/share/nginx/html:ro
      # Opcional: Configuraci√≥n personalizada de Nginx
      # - ./nginx.conf:/etc/nginx/nginx.conf:ro

    ports:
      - '80:80'

    depends_on:
      - backend

    # Red personalizada para aislamiento
    networks:
      - frontend_net
      - backend_net

  # ---------------------------------------------------------------------------
  # SERVICIO: Backend API (Node.js, Python, etc.)
  # ---------------------------------------------------------------------------
  # ¬øQu√©? - Servidor de aplicaci√≥n con l√≥gica de negocio
  # ¬øPara qu√©? - Procesar peticiones, validar datos, comunicarse con la BD
  # ¬øC√≥mo? - Expone API REST en el puerto 3000
  #
  # NOTA: Este es un ejemplo gen√©rico. Debes adaptarlo seg√∫n tu tecnolog√≠a:
  # - Node.js: image: node:18-alpine + volumes con tu c√≥digo
  # - Python: image: python:3.11-slim + requirements.txt
  # - Java: image: openjdk:17-slim
  backend:
    # Opci√≥n 1: Usar imagen pre-construida
    image: node:18-alpine

    # Opci√≥n 2: Construir desde Dockerfile local
    # build:
    #   context: ./backend
    #   dockerfile: Dockerfile

    container_name: proyecto_backend
    restart: unless-stopped

    # Working directory dentro del contenedor
    working_dir: /app

    # Montar c√≥digo fuente (para desarrollo)
    # ¬øQu√©? - Carpeta backend/ montada en el contenedor
    # ¬øPara qu√©? - Hot reload durante desarrollo
    volumes:
      - ./backend:/app
      - backend_node_modules:/app/node_modules # Cache de dependencias

    # Puertos - API REST
    ports:
      - '3000:3000'

    # Variables de entorno - Configuraci√≥n de la aplicaci√≥n
    environment:
      NODE_ENV: development
      PORT: 3000
      DB_HOST: db # ¬°IMPORTANTE! Usar nombre del servicio, no 'localhost'
      DB_PORT: 5432
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      # JWT Secret (para autenticaci√≥n)
      JWT_SECRET: ${JWT_SECRET}

    # Comando de inicio (ajustar seg√∫n tu framework)
    command: npm start
    # Para Python: command: python app.py
    # Para Java: command: java -jar app.jar

    depends_on:
      db:
        condition: service_healthy

    networks:
      - backend_net

  # ---------------------------------------------------------------------------
  # SERVICIO: Base de Datos PostgreSQL
  # ---------------------------------------------------------------------------
  # ¬øQu√©? - Sistema de gesti√≥n de base de datos relacional
  # ¬øPara qu√©? - Almacenar datos de forma estructurada y persistente
  db:
    image: postgres:15-alpine
    container_name: proyecto_db
    restart: unless-stopped

    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
      # Configuraci√≥n de conexiones
      POSTGRES_MAX_CONNECTIONS: 100
      # Configuraci√≥n de memoria (ajustar seg√∫n recursos disponibles)
      POSTGRES_SHARED_BUFFERS: 256MB

    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Scripts de inicializaci√≥n
      - ./database/init.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ./database/seed.sql:/docker-entrypoint-initdb.d/02-data.sql:ro

    # Puerto expuesto (comentar en producci√≥n por seguridad)
    ports:
      - '5432:5432'

    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${DB_USER} -d ${DB_NAME}']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    networks:
      - backend_net

  # ---------------------------------------------------------------------------
  # SERVICIO: Adminer (Administrador de Base de Datos)
  # ---------------------------------------------------------------------------
  # ¬øQu√©? - Herramienta web para administrar PostgreSQL
  # ¬øPara qu√©? - Desarrollo y depuraci√≥n de consultas SQL
  adminer:
    image: adminer:latest
    container_name: proyecto_adminer
    restart: unless-stopped

    ports:
      - '8080:8080'

    environment:
      ADMINER_DEFAULT_SERVER: db
      ADMINER_DESIGN: pepa-linha # Tema visual (opcional)

    depends_on:
      db:
        condition: service_healthy

    networks:
      - backend_net

# =============================================================================
# REDES - Segmentaci√≥n de Servicios
# =============================================================================
# ¬øQu√©? - Redes virtuales para aislar servicios
# ¬øPara qu√©? - Seguridad: Frontend no accede directamente a la BD
# ¬øC√≥mo? - Frontend solo puede comunicarse con Backend
#          Backend puede comunicarse con Frontend y DB
networks:
  frontend_net:
    driver: bridge
    name: frontend_network

  backend_net:
    driver: bridge
    name: backend_network

# =============================================================================
# VOL√öMENES - Almacenamiento Persistente
# =============================================================================
volumes:
  postgres_data:
    driver: local
    # Opcional: Especificar ubicaci√≥n en el host
    # driver_opts:
    #   type: none
    #   o: bind
    #   device: /ruta/en/el/host/postgres_data

  backend_node_modules:
    driver: local
# =============================================================================
# ESTRUCTURA DE CARPETAS REQUERIDA
# =============================================================================
#
# mi-proyecto-completo/
# ‚îú‚îÄ‚îÄ docker-compose.yml      (este archivo)
# ‚îú‚îÄ‚îÄ .env                    (variables de entorno)
# ‚îú‚îÄ‚îÄ frontend/               (interfaz de usuario)
# ‚îÇ   ‚îú‚îÄ‚îÄ index.html
# ‚îÇ   ‚îú‚îÄ‚îÄ styles.css
# ‚îÇ   ‚îî‚îÄ‚îÄ script.js
# ‚îú‚îÄ‚îÄ backend/                (API y l√≥gica de negocio)
# ‚îÇ   ‚îú‚îÄ‚îÄ package.json        (dependencias Node.js)
# ‚îÇ   ‚îú‚îÄ‚îÄ app.js              (punto de entrada)
# ‚îÇ   ‚îú‚îÄ‚îÄ routes/             (endpoints de la API)
# ‚îÇ   ‚îú‚îÄ‚îÄ controllers/        (l√≥gica de negocio)
# ‚îÇ   ‚îî‚îÄ‚îÄ models/             (modelos de datos)
# ‚îî‚îÄ‚îÄ database/               (scripts SQL)
#     ‚îú‚îÄ‚îÄ init.sql            (esquema: CREATE TABLE)
#     ‚îî‚îÄ‚îÄ seed.sql            (datos iniciales: INSERT)
#
# =============================================================================
# EJEMPLO: .env
# =============================================================================
#
# # Configuraci√≥n de Base de Datos
# DB_NAME=proyecto_produccion
# DB_USER=admin_proyecto
# DB_PASSWORD=P@ssw0rd_Segur0_2024!
#
# # Configuraci√≥n de Backend
# JWT_SECRET=clave_secreta_muy_larga_y_aleatoria_aqui
# API_PORT=3000
#
# # Entorno
# NODE_ENV=production
#
# =============================================================================
# EJEMPLO: backend/package.json (Node.js)
# =============================================================================
#
# {
#   "name": "proyecto-backend",
#   "version": "1.0.0",
#   "main": "app.js",
#   "scripts": {
#     "start": "node app.js",
#     "dev": "nodemon app.js"
#   },
#   "dependencies": {
#     "express": "^4.18.0",
#     "pg": "^8.11.0",
#     "dotenv": "^16.0.0",
#     "cors": "^2.8.5"
#   }
# }
#
# =============================================================================
# EJEMPLO: backend/app.js (Node.js + Express)
# =============================================================================
#
# const express = require('express');
# const { Pool } = require('pg');
# const cors = require('cors');
#
# const app = express();
# const port = process.env.PORT || 3000;
#
# // Configuraci√≥n de PostgreSQL
# const pool = new Pool({
#   host: process.env.DB_HOST,
#   port: process.env.DB_PORT,
#   database: process.env.DB_NAME,
#   user: process.env.DB_USER,
#   password: process.env.DB_PASSWORD,
# });
#
# // Middlewares
# app.use(cors());
# app.use(express.json());
#
# // Endpoint de prueba
# app.get('/api/health', (req, res) => {
#   res.json({ status: 'OK', timestamp: new Date() });
# });
#
# // Endpoint de ejemplo: Listar todos los registros
# app.get('/api/items', async (req, res) => {
#   try {
#     const result = await pool.query('SELECT * FROM mi_tabla');
#     res.json(result.rows);
#   } catch (error) {
#     res.status(500).json({ error: error.message });
#   }
# });
#
# app.listen(port, () => {
#   console.log(`Backend corriendo en http://localhost:${port}`);
# });
#
# =============================================================================
# INSTRUCCIONES DE USO
# =============================================================================
#
# 1. PREPARAR ESTRUCTURA DE CARPETAS (ver arriba)
#
# 2. CREAR ARCHIVO .env CON CREDENCIALES
#
# 3. CREAR SCRIPTS SQL EN database/
#    - init.sql: Definir esquema (CREATE TABLE)
#    - seed.sql: Insertar datos iniciales
#
# 4. IMPLEMENTAR BACKEND EN backend/
#    - Instalar dependencias: npm install (fuera del contenedor)
#    - Escribir l√≥gica de negocio y endpoints
#
# 5. CREAR FRONTEND EN frontend/
#    - HTML para la interfaz
#    - JavaScript para consumir API del backend
#
# 6. INICIAR STACK COMPLETO:
#    docker compose up -d
#
# 7. VERIFICAR SERVICIOS:
#    docker compose ps
#    docker compose logs -f backend
#
# 8. ACCESOS:
#    - Frontend: http://localhost
#    - Backend API: http://localhost:3000
#    - Adminer: http://localhost:8080
#    - PostgreSQL: localhost:5432
#
# 9. DESARROLLO: MODIFICAR C√ìDIGO
#    Los cambios en backend/ y frontend/ se reflejan autom√°ticamente
#    (gracias a los vol√∫menes montados)
#
# 10. DETENER TODO:
#     docker compose down
#
# 11. ELIMINAR TODO (incluidos datos):
#     docker compose down -v
#
# =============================================================================
# TROUBLESHOOTING
# =============================================================================
#
# ‚ùå Backend no puede conectar a la base de datos
#    Soluci√≥n: Usar 'db' como DB_HOST, no 'localhost'
#
# ‚ùå Frontend no puede hacer fetch al backend
#    Soluci√≥n: Usar 'http://localhost:3000' (desde el navegador)
#              NO usar 'http://backend:3000'
#
# ‚ùå "Cannot find module" en backend
#    Soluci√≥n: Instalar dependencias primero
#              cd backend && npm install
#
# ‚ùå Cambios en frontend no se reflejan
#    Soluci√≥n: Limpiar cach√© del navegador (Ctrl+Shift+R)
#
# ‚ùå Puerto ya est√° en uso
#    Soluci√≥n: Cambiar puertos en docker-compose.yml
#              Ejemplo: "8000:80" en lugar de "80:80"
#
# ‚ùå Volumen de PostgreSQL corrupto
#    Soluci√≥n: Eliminar volumen y recrear
#              docker compose down -v
#              docker compose up -d
#
# =============================================================================
# NOTAS DE PRODUCCI√ìN
# =============================================================================
#
# üîí SEGURIDAD:
# - Comentar puertos expuestos innecesarios (5432, 8080)
# - Usar contrase√±as fuertes en .env
# - Nunca subir .env al repositorio (agregar a .gitignore)
# - Considerar usar Docker Secrets en lugar de .env
#
# ‚ö° RENDIMIENTO:
# - Ajustar POSTGRES_SHARED_BUFFERS seg√∫n RAM disponible
# - Configurar l√≠mites de recursos (memory, cpus)
# - Usar im√°genes alpine para reducir tama√±o
#
# üìä MONITOREO:
# - Implementar logs estructurados en backend
# - Usar docker compose logs para depuraci√≥n
# - Considerar agregar servicio de monitoreo (Prometheus, Grafana)
#
# üîÑ CI/CD:
# - Automatizar builds con GitHub Actions
# - Implementar tests antes del despliegue
# - Usar tags de versi√≥n en im√°genes
#
# =============================================================================
